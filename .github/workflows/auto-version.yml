# .github/workflows/auto-version.yml
name: Auto Version and Deploy
on:
  push:
    branches:
      - main

jobs:
  version-and-deploy:
    runs-on: ubuntu-latest
    # First, we need to ensure the job has access to the token
    env:
      GH_TOKEN: ${{ secrets.degen_almanack_version_publish }}
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          # We use the token here for initial checkout
          token: ${{ secrets.degen_almanack_version_publish }}
          
      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml semver
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin texlive-xetex texlive-fonts-recommended texlive-extra-utils
          
      - name: Verify SVG conversion tool
        run: |
          which rsvg-convert || echo "rsvg-convert not found"
          rsvg-convert --version || echo "rsvg-convert not working"
          
      - name: Bump version
        id: bump-version
        run: |
          python .github/scripts/bump_version.py minor
          echo "NEW_VERSION=$(cat version.txt)" >> $GITHUB_ENV
          
      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        
      - name: Install TinyTeX
        run: |
          quarto install tinytex
          
      - name: Render Book
        run: |
          quarto render
          
      - name: Handle PDF
        run: |
          if [ -f "docs/Trollip-s-Degen-Almanack.pdf" ]; then
            cp "docs/Trollip-s-Degen-Almanack.pdf" "docs/Trollip-s-Degen-Almanack-v${NEW_VERSION}.pdf"
          else
            echo "PDF files in docs:"
            find docs -name "*.pdf"
            exit 1
          fi
          
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
      - name: Commit and push changes
        # Using a separate step for debugging purposes
        run: |
          # Debug: Print git remote (without exposing token)
          echo "Current remote:"
          git remote -v | sed 's/https:\/\/.*@/https:\/\/***@/'
          
          # Set the remote with the token
          git remote set-url origin "https://${{ secrets.degen_almanack_version_publish }}@github.com/${{ github.repository }}.git"
          
          # Debug: Verify remote was set (without exposing token)
          echo "New remote:"
          git remote -v | sed 's/https:\/\/.*@/https:\/\/***@/'
          
          # Add and commit changes
          git add version.txt _quarto.yml docs/
          git commit -m "Auto version bump and build [skip ci]"
          
          # Push with debug output
          echo "Attempting to push..."
          git push origin HEAD:main || {
            echo "Push failed. Checking git status:"
            git status
            exit 1
          }